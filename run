#!/usr/bin/env bash

set -euo pipefail

# Color definitions
COLOR_RESET="\033[0m"
COLOR_BOLD="\033[1m"
COLOR_GREEN="\033[0;32m"
COLOR_YELLOW="\033[0;33m"
COLOR_BLUE="\033[0;34m"
COLOR_CYAN="\033[0;36m"
COLOR_RED="\033[0;31m"

script_dir=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)

filter=""
choose=""
dry="0"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --dry)
      dry="1"
      ;;
    --filter)
      shift
      filter="$1"
      ;;
    --choose)
      shift
      choose="$1"
      ;;
    *)
      echo "Unknown option: $1"
      echo "Usage: $0 [--dry] [--filter PATTERN] [--choose PATTERN]"
      echo "  --dry: Show what would be executed without running"
      echo "  --filter PATTERN: Skip scripts matching PATTERN"
      echo "  --choose PATTERN: Only run scripts matching PATTERN"
      exit 1
      ;;
  esac
  shift
done

log() {
  if [[ $dry == "1" ]]; then
	echo -e "${COLOR_YELLOW}[DRY_RUN]:${COLOR_RESET} $*"
  else
	echo -e "${COLOR_CYAN}$*${COLOR_RESET}"
  fi
}

execute() {
  local script_name=$(basename "$1")
  echo -e "\n${COLOR_BOLD}${COLOR_BLUE}==>${COLOR_RESET} ${COLOR_BOLD}Running: $script_name${COLOR_RESET}"

  if [[ $dry == "1" ]]; then
	return 0
  fi

  if "$@"; then
    echo -e "${COLOR_GREEN}✓${COLOR_RESET} ${COLOR_BOLD}$script_name${COLOR_RESET} ${COLOR_GREEN}completed successfully${COLOR_RESET}"
    return 0
  else
    echo -e "${COLOR_RED}✗${COLOR_RESET} ${COLOR_BOLD}$script_name${COLOR_RESET} ${COLOR_RED}failed${COLOR_RESET}"
    return 1
  fi
}

echo -e "${COLOR_BOLD}${COLOR_CYAN}========================================${COLOR_RESET}"
echo -e "${COLOR_BOLD}${COLOR_CYAN}  dev-env installation${COLOR_RESET}"
echo -e "${COLOR_BOLD}${COLOR_CYAN}========================================${COLOR_RESET}"
log "filter: '$filter' | choose: '$choose'"

cd "$script_dir"

scripts=$(find ./runs -maxdepth 1 -mindepth 1 -executable -type f | sort)

for script in $scripts; do
  # If choose is set, only run scripts matching the pattern
  if [[ -n "$choose" ]]; then
    if ! echo "$script" | grep -q "$choose"; then
      log "⊘ not chosen: $script"
      continue
    fi
  fi

  # If filter is set, skip scripts matching the pattern
  if [[ -n "$filter" ]]; then
    if echo "$script" | grep -q "$filter"; then
      log "⊗ filtering: $script"
      continue
    fi
  fi

  execute "$script"
done

echo -e "\n${COLOR_BOLD}${COLOR_GREEN}========================================${COLOR_RESET}"
echo -e "${COLOR_BOLD}${COLOR_GREEN}  Installation complete!${COLOR_RESET}"
echo -e "${COLOR_BOLD}${COLOR_GREEN}========================================${COLOR_RESET}"
